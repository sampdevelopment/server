name: Build SA-MP Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository (with submodules)
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install build tools
      run: |
        sudo apt update
        sudo apt install -y gcc g++ make

    - name: Build Release (mpsvr)
      run: |
        mkdir -p build/release
        cd build/release

        gcc -O2 -c -fpack-struct=1 -w \
          -I../../SDK/amx \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          ../../SDK/amx/*.c

        g++ -O2 -c -fpack-struct=1 -w \
          -I../../SDK/amx \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          ../../*.cpp

        g++ -O2 -c -fpack-struct=1 -w \
          -I../../SDK/amx \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          ../../SDK/raknet/*.cpp

        g++ -O2 -fpack-struct=1 -w \
          -I../../SDK/amx \
          -ldl -lpthread -lm \
          -o mpsvr \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          *.o

    - name: Build Debug (mpsvrd)
      run: |
        mkdir -p build/debug
        cd build/debug

        gcc -c -g -fpack-struct=1 -w \
          -I../../SDK/amx \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          ../../SDK/amx/*.c

        g++ -c -g -fpack-struct=1 -w \
          -I../../SDK/amx \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          ../../*.cpp

        g++ -c -g -fpack-struct=1 -w \
          -I../../SDK/amx \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          ../../SDK/raknet/*.cpp

        g++ -g -fpack-struct=1 -w \
          -I../../SDK/amx \
          -ldl -lpthread -lm \
          -o mpsvrd \
          -DLINUX -DSAMPSRV -DAMX_NODYNALOAD \
          *.o

    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: samp-server-linux
        path: |
          build/release/mpsvr
          build/debug/mpsvrd

          //test
